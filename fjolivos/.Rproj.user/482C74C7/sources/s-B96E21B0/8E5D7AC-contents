library(poLCA)
library(haven)
library(gnm)

#Import Data from Stata
ECLforR <- read_dta("C:/Users/fjoli/Dropbox/Data/Comportamiento lector/ECLforR.dta")

#####LATENT CLASS ANALYSYS 

data(ECLforR)
ECLforR$B1A<- as.numeric(ECLforR$B1A)
is.numeric(ECLforR$B1A)
ECLforR$B1B<- as.numeric(ECLforR$B1B)
is.numeric(ECLforR$B1B)
ECLforR$C1<- as.numeric(ECLforR$C1)
is.numeric(ECLforR$C1)
ECLforR$D1<- as.numeric(ECLforR$D1)
is.numeric(ECLforR$D1)
ECLforR$E1A<- as.numeric(ECLforR$E1A)
is.numeric(ECLforR$E1A)
ECLforR$E1B<- as.numeric(ECLforR$E1B)
is.numeric(ECLforR$E1B)
ECLforR$F1A<- as.numeric(ECLforR$F1A)
is.numeric(ECLforR$F1A)
ECLforR$F1B<- as.numeric(ECLforR$F1B)
is.numeric(ECLforR$F1B)

f <- cbind(B1A, B1B, C1, D1, E1A, E1B, F1A, F1B)~1
read.lc <- poLCA(f,ECLforR,nclass=3, na.rm = TRUE,  maxiter = 3000, nrep=10, graphs = TRUE)

#Binded to the original data

ECLforR.predclass <- cbind(ECLforR, class2 = read.lc$predclass)
head(ECLforR.predclass)

##### MULTINOMIAL DIAGONAL REFERENCE MODEL

#see pag 46 https://cran.r-project.org/web/packages/gnm/vignettes/gnmOverview.pdf

ECLforRLong <- expandCategorical(ECLforR.predclass, "class2")

head(ECLforRLong)

#Multinomial model of latent class predicted by sociodemographics

sixDimensional <- gnm(count ~ class2 + class2:(gender + hincome + occ2 + edu3),
                    eliminate = id, family = "poisson", data = ECLforRLong)
sixDimensional

ECLforRLong$edu3<-as.factor(ECLforRLong$edu3)
ECLforRLong$eduf3<-as.factor(ECLforRLong$eduf3)

is.factor(ECLforRLong$edu3)
is.factor(ECLforRLong$eduf3)

classMobility <- gnm(count ~ class2 + class2:(gender + hincome + occ2) + Dref(eduf3, edu3),
                      eliminate = id, family = "poisson", data = ECLforRLong)
classMobility

classMobility <- gnm(count ~ class2 + class2:(gender + hincome + occ2) + Dref(eduf3, edu3, delta = ~ 1 + class2),
                     eliminate = id, family = "poisson", data = ECLforRLong)

m1 <- gnm(count ~ Dref(cat:eduf3, cat:edu3,
                       delta = ~ -1 + cat),
          eliminate = id,
          constrain = c("(delta1)|(catI)|(I:)"),
          family = poisson,
          data = ECLforRLong)
summary(m1)
DrefWeights(m1)
